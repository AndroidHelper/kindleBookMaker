<!DOCTYPE html>
<html>
<head>
  
  <title>&#x672C;&#x535A;&#x5BA2; Nginx &#x914D;&#x7F6E;&#x4E4B;&#x5B8C;&#x6574;&#x7BC7;</title>
  
</head>
<body>

<div id="wrap">
  <h1>&#x672C;&#x535A;&#x5BA2; Nginx &#x914D;&#x7F6E;&#x4E4B;&#x5B8C;&#x6574;&#x7BC7;</h1>
  <div id="content"><p>&#x6700;&#x8FD1;&#x6709;&#x5F88;&#x591A;&#x670B;&#x53CB;&#x90AE;&#x4EF6;&#x6216;&#x8005;&#x7559;&#x8A00;&#x8BE2;&#x95EE;&#x672C;&#x535A;&#x5BA2;&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x76F8;&#x5173;&#x95EE;&#x9898;&#xFF0C;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x5173;&#x4E8E; HTTPS &#x548C; HTTP/2 &#x7684;&#xFF0C;&#x5176;&#x5B9E;&#x6211;&#x7684; Nginx &#x914D;&#x7F6E;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x6587;&#x7AE0;&#x4E2D;&#x591A;&#x6B21;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x4E0D;&#x8FC7;&#x90FD;&#x6BD4;&#x8F83;&#x5206;&#x6563;&#x3002;&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x5927;&#x5BB6;&#x53C2;&#x8003;&#xFF0C;&#x672C;&#x6587;&#x8D34;&#x51FA;&#x5B8C;&#x6574;&#x914D;&#x7F6E;&#x3002;</p>
<blockquote>
<p>&#x672C;&#x6587;&#x5185;&#x5BB9;&#x4F1A;&#x968F;&#x65F6;&#x8C03;&#x6574;&#x6216;&#x66F4;&#x65B0;&#xFF0C;&#x8BF7;&#x5927;&#x5BB6;&#x4E0D;&#x8981;&#x628A;&#x672C;&#x6587;&#x5185;&#x5BB9;&#x5168;&#x6587;&#x8F6C;&#x8F7D;&#x5230;&#x7B2C;&#x4E09;&#x65B9;&#x5E73;&#x53F0;&#xFF0C;&#x4EE5;&#x514D;&#x7ED9;&#x4ED6;&#x4EBA;&#x9020;&#x6210;&#x56F0;&#x6270;&#x6216;&#x8BEF;&#x5BFC;&#x3002;&#x53E6;&#x5916;&#x9650;&#x4E8E;&#x7BC7;&#x5E45;&#xFF0C;&#x672C;&#x6587;&#x4E0D;&#x4F1A;&#x5BF9;&#x914D;&#x7F6E;&#x505A;&#x8FC7;&#x591A;&#x8BF4;&#x660E;&#xFF0C;&#x5982;&#x6709;&#x7591;&#x95EE;&#x6216;&#x4E0D;&#x540C;&#x610F;&#x89C1;&#xFF0C;&#x6B22;&#x8FCE;&#x7559;&#x8A00;&#x6307;&#x51FA;&#x3002;</p>
</blockquote>

<h3 id="-">&#x51C6;&#x5907;&#x5DE5;&#x4F5C;</h3>
<p>&#x6211;&#x7684; VPS &#x7CFB;&#x7EDF;&#x662F; Ubuntu 14.04.4 LTS&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x5176;&#x5B83;&#x53D1;&#x884C;&#x7248;&#xFF0C;&#x4E0E;&#x5305;&#x7BA1;&#x7406;&#x6709;&#x5173;&#x7684;&#x547D;&#x4EE4;&#x8BF7;&#x81EA;&#x884C;&#x8C03;&#x6574;&#x3002;</p>
<p>&#x672C;&#x535A;&#x5BA2;&#x662F;&#x6211;&#x7684;&#x8BD5;&#x9A8C;&#x7530;&#xFF0C;Nginx &#x81EA;&#x7136;&#x8981;&#x7528;&#x6700;&#x65B0;&#x7684; 1.9.15&#x3002;&#x4E3A;&#x4E86;&#x542F;&#x7528; Certificate Transparency&#xFF0C;&#x6211;&#x4F7F;&#x7528;&#x4E86; nginx-ct &#x8FD9;&#x4E2A;&#x6A21;&#x5757;&#x3002;&#x540C;&#x65F6;&#xFF0C;&#x6211;&#x8FD8;&#x4F7F;&#x7528;&#x4E86; CloudFlare Patch &#x8FC7;&#x7684; OpenSSL 1.0.2g &#x505A;&#x4E3A; Nginx &#x7684; SSL &#x5E93;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x5B8C;&#x6574;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>&#x9996;&#x5148;&#x5B89;&#x88C5;&#x4F9D;&#x8D56;&#x5E93;&#x548C;&#x7F16;&#x8BD1;&#x8981;&#x7528;&#x5230;&#x7684;&#x5DE5;&#x5177;&#xFF1A;</p>
<pre><code class="lang-bash">sudo apt-get install build-essential libpcre3 libpcre3-dev zlib1g-dev unzip git
</code></pre>
<p>&#x7136;&#x540E;&#x83B7;&#x53D6; OpenSSL &#x6E90;&#x7801;&#x548C; Patch&#x3001;&#x6700;&#x65B0;&#x7684; Nginx &#x4EE5;&#x53CA; nginx-ct &#x6E90;&#x7801;&#xFF0C;&#x5F00;&#x59CB;&#x7F16;&#x8BD1;&#xFF1A;</p>
<pre><code class="lang-bash">git <span class="hljs-built_in">clone</span> https://github.com/cloudflare/sslconfig
wget -O openssl.zip -c https://github.com/openssl/openssl/archive/OpenSSL_1_0_2g.zip
unzip openssl.zip
mv openssl-OpenSSL_1_0_2g/ openssl
<span class="hljs-built_in">cd</span> openssl &amp;&amp; patch -p1 &lt; ../sslconfig/patches/openssl__chacha20_poly1305_draft_and_rfc_ossl102g.patch 

<span class="hljs-built_in">cd</span> ../

wget -c http://nginx.org/download/nginx-<span class="hljs-number">1.9</span>.<span class="hljs-number">15</span>.tar.gz
tar zxf nginx-<span class="hljs-number">1.9</span>.<span class="hljs-number">15</span>.tar.gz

wget -O nginx-ct.zip -c https://github.com/grahamedgecombe/nginx-ct/archive/v1.<span class="hljs-number">2.0</span>.zip
unzip nginx-ct.zip

<span class="hljs-built_in">cd</span> nginx-<span class="hljs-number">1.9</span>.<span class="hljs-number">15</span>/

./configure --add-module=../nginx-ct-<span class="hljs-number">1.2</span>.<span class="hljs-number">0</span> --with-openssl=../openssl --with-http_v2_module --with-http_ssl_module
make
sudo make install
</code></pre>
<p>Nginx &#x9ED8;&#x8BA4;&#x88C5;&#x5728; <code>/usr/local/nginx/</code> &#x76EE;&#x5F55;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x66F4;&#x6539;&#x8DEF;&#x5F84;&#x53EF;&#x4EE5;&#x5728; configure &#x65F6;&#x6307;&#x5B9A;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x7BA1;&#x7406; Nginx &#x670D;&#x52A1;&#xFF0C;&#x518D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7BA1;&#x7406;&#x811A;&#x672C;&#xFF1A;</p>
<pre><code class="lang-bash">sudo vim /etc/init.d/nginx
</code></pre>
<p>&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-bash"><span class="hljs-shebang">#! /bin/sh
</span>
<span class="hljs-comment">### BEGIN INIT INFO</span>
<span class="hljs-comment"># Provides:          nginx</span>
<span class="hljs-comment"># Required-Start:    $all</span>
<span class="hljs-comment"># Required-Stop:     $all</span>
<span class="hljs-comment"># Default-Start:     2 3 4 5</span>
<span class="hljs-comment"># Default-Stop:      0 1 6</span>
<span class="hljs-comment"># Short-Description: starts the nginx web server</span>
<span class="hljs-comment"># Description:       starts nginx using start-stop-daemon</span>
<span class="hljs-comment">### END INIT INFO</span>

PATH=/usr/<span class="hljs-built_in">local</span>/sbin:/usr/<span class="hljs-built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/<span class="hljs-built_in">local</span>/nginx/sbin/nginx
NAME=nginx
DESC=nginx

<span class="hljs-built_in">test</span> -x <span class="hljs-variable">$DAEMON</span> || <span class="hljs-built_in">exit</span> <span class="hljs-number">0</span>

<span class="hljs-comment"># Include nginx defaults if available</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-operator">-f</span> /etc/default/nginx ] ; <span class="hljs-keyword">then</span>
  . /etc/default/nginx
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">set</span> <span class="hljs-operator">-e</span>

. /lib/lsb/init-functions

<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> <span class="hljs-keyword">in</span>
  start)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;Starting <span class="hljs-variable">$DESC</span>: &quot;</span>
    start-stop-daemon --start --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> -- <span class="hljs-variable">$DAEMON_OPTS</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.&quot;</span>
    ;;
  stop)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;Stopping <span class="hljs-variable">$DESC</span>: &quot;</span>
    start-stop-daemon --stop --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.&quot;</span>
    ;;
  restart|force-reload)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;Restarting <span class="hljs-variable">$DESC</span>: &quot;</span>
    start-stop-daemon --stop --quiet --pidfile \
        /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    sleep <span class="hljs-number">1</span>
    start-stop-daemon --start --quiet --pidfile \
        /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid --exec <span class="hljs-variable">$DAEMON</span> -- <span class="hljs-variable">$DAEMON_OPTS</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.&quot;</span>
    ;;
  reload)
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">&quot;Reloading <span class="hljs-variable">$DESC</span> configuration: &quot;</span>
    start-stop-daemon --stop --signal HUP --quiet --pidfile /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid \
        --exec <span class="hljs-variable">$DAEMON</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$NAME</span>.&quot;</span>
    ;;
  status)
    status_of_proc -p /usr/<span class="hljs-built_in">local</span>/nginx/logs/<span class="hljs-variable">$NAME</span>.pid <span class="hljs-string">&quot;<span class="hljs-variable">$DAEMON</span>&quot;</span> nginx &amp;&amp; <span class="hljs-built_in">exit</span> <span class="hljs-number">0</span> || <span class="hljs-built_in">exit</span> $?
    ;;
  *)
    N=/etc/init.d/<span class="hljs-variable">$NAME</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Usage: <span class="hljs-variable">$N</span> {start|stop|restart|reload|force-reload|status}&quot;</span> &gt;&amp;<span class="hljs-number">2</span>
    <span class="hljs-built_in">exit</span> <span class="hljs-number">1</span>
    ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-built_in">exit</span> <span class="hljs-number">0</span>
</code></pre>
<p>&#x589E;&#x52A0;&#x6267;&#x884C;&#x6743;&#x9650;&#xFF1A;</p>
<pre><code class="lang-bash">sudo chmod a+x /etc/init.d/nginx
</code></pre>
<p>&#x73B0;&#x5728;&#x7BA1;&#x7406; Nginx &#x53EA;&#x9700;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5373;&#x53EF;&#xFF1A;</p>
<pre><code class="lang-bash">sudo service nginx start|stop|restart|reload
</code></pre>
<p>&#x5982;&#x679C;&#x8981;&#x5F00;&#x673A;&#x81EA;&#x52A8;&#x542F;&#x52A8; Nginx&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code class="lang-bash">sudo update-rc.d <span class="hljs-operator">-f</span> nginx defaults
</code></pre>
<p>&#x5230;&#x6B64;&#x4E3A;&#x6B62;&#xFF0C;Nginx &#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x5B8C;&#x6BD5;&#x3002;&#x518D;&#x6765;&#x4FEE;&#x6539;&#x4E00;&#x4E0B;&#x5B83;&#x7684;&#x5168;&#x5C40;&#x914D;&#x7F6E;&#xFF0C;&#x6253;&#x5F00; <code>/usr/local/nginx/conf/nginx.conf</code>&#xFF0C;&#x65B0;&#x589E;&#x6216;&#x4FEE;&#x6539;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-nginx"><span class="hljs-title">http</span> {
    <span class="hljs-title">include</span>            mime.types;
    <span class="hljs-title">default_type</span>       application/octet-stream;

    <span class="hljs-title">sendfile</span>           <span class="hljs-built_in">on</span>;
    <span class="hljs-title">tcp_nopush</span>         <span class="hljs-built_in">on</span>;
    <span class="hljs-title">tcp_nodelay</span>        <span class="hljs-built_in">on</span>;

    <span class="hljs-title">keepalive_timeout</span>  <span class="hljs-number">60</span>;

    <span class="hljs-comment">#... ...#</span>

    <span class="hljs-title">gzip</span>               <span class="hljs-built_in">on</span>;
    <span class="hljs-title">gzip_vary</span>          <span class="hljs-built_in">on</span>;

    <span class="hljs-title">gzip_comp_level</span>    <span class="hljs-number">6</span>;
    <span class="hljs-title">gzip_buffers</span>       <span class="hljs-number">16</span> <span class="hljs-number">8k</span>;

    <span class="hljs-title">gzip_min_length</span>    <span class="hljs-number">1000</span>;
    <span class="hljs-title">gzip_proxied</span>       any;
    <span class="hljs-title">gzip_disable</span>       <span class="hljs-string">&quot;msie6&quot;</span>;

    <span class="hljs-title">gzip_http_version</span>  <span class="hljs-number">1</span>.<span class="hljs-number">0</span>;

    <span class="hljs-title">gzip_types</span>         text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript image/svg+xml;

    <span class="hljs-comment">#... ...#</span>

    <span class="hljs-title">include</span>            /home/jerry/www/nginx_conf/<span class="hljs-regexp">*.conf</span>;
}
</code></pre>
<p>&#x6700;&#x540E;&#x7684; <code>include</code> &#x7528;&#x6765;&#x52A0;&#x8F7D;&#x6211;&#x4E2A;&#x4EBA;&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x8FD9;&#x6837;&#x4ECA;&#x540E;&#x521B;&#x5EFA;&#x548C;&#x4FEE;&#x6539;&#x7AD9;&#x70B9;&#x914D;&#x7F6E;&#x5C31;&#x4E0D;&#x9700;&#x8981;&#x518D;&#x4F7F;&#x7528; sudo &#x6743;&#x9650;&#x4E86;&#x3002;</p>
<p>&#x8981;&#x8BA9;&#x7F51;&#x7AD9;&#x652F;&#x6301;&#x6D4F;&#x89C8;&#x5668;&#x901A;&#x8FC7; HTTP/2 &#x8BBF;&#x95EE;&#x5FC5;&#x987B;&#x5148;&#x90E8;&#x7F72; HTTPS&#xFF0C;&#x8981;&#x90E8;&#x7F72; HTTPS &#x5FC5;&#x987B;&#x5148;&#x6709;&#x5408;&#x6CD5;&#x7684;&#x8BC1;&#x4E66;&#x3002;&#x672C;&#x535A;&#x5BA2;&#x76EE;&#x524D;&#x5728;&#x7528; RapidSSL &#x5355;&#x57DF;&#x540D;&#x8BC1;&#x4E66;&#xFF0C;&#x5728; <a href="https://www.namecheap.com/security/ssl-certificates/rapidssl/rapidssl.aspx">NameCheap</a> &#x8D2D;&#x4E70;&#x3002;&#x53E6;&#x5916;&#xFF0C;&#x6211;&#x8FD8;&#x7533;&#x8BF7;&#x4E86; <a href="http://www.letsencrypt.org/">Let&apos;s Encrypt</a> &#x7684;&#x514D;&#x8D39;&#x8BC1;&#x4E66;&#x5907;&#x7528;&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E2A;&#x4EBA;&#x4F7F;&#x7528; Let&apos;s Encrypt &#x7684;&#x514D;&#x8D39;&#x8BC1;&#x4E66;&#x5C31;&#x8DB3;&#x591F;&#x4E86;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x8282;&#x7701;&#x4E00;&#x7B14;&#x5F00;&#x9500;&#x3002;</p>
<p>&#x8981;&#x7533;&#x8BF7; Let&apos;s Encrypt &#x8BC1;&#x4E66;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528; <a href="https://github.com/Neilpang/acme.sh">Neilpang/acme.sh</a> &#x8FD9;&#x4E2A;&#x5C0F;&#x5DE7;&#x65E0;&#x4F9D;&#x8D56;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x5DE5;&#x5177;&#xFF0C;&#x6216;&#x8005;&#x53C2;&#x8003;&#x6211;&#x7684;&#x8FD9;&#x7BC7;&#x6587;&#x7AE0;&#xFF1A;<a href="https://imququ.com/post/letsencrypt-certificate.html">Let&apos;s Encrypt&#xFF0C;&#x514D;&#x8D39;&#x597D;&#x7528;&#x7684; HTTPS &#x8BC1;&#x4E66;</a>&#x3002;</p>
<p>&#x6CE8;&#xFF1A;Let&apos;s Encrypt &#x5DF2;&#x4E8E; 2016 &#x5E74; 3 &#x6708; 26 &#x65E5;&#x4FEE;&#x590D; Windows XP &#x4E0B;&#x7684;&#x517C;&#x5BB9;&#x95EE;&#x9898;&#xFF0C;&#x672C;&#x7AD9;&#x4E5F;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x5207;&#x6362;&#x5230; Let&apos;s Encrypt &#x8BC1;&#x4E66;&#x3002;</p>
<h3 id="-">&#x7AD9;&#x70B9;&#x914D;&#x7F6E;</h3>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x672C;&#x535A;&#x5BA2;&#x7AD9;&#x70B9;&#x5B8C;&#x6574;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-nginx"><span class="hljs-title">server</span> {
    <span class="hljs-title">listen</span>               <span class="hljs-number">443</span> ssl http2 fastopen=<span class="hljs-number">3</span> reuseport;

    <span class="hljs-title">server_name</span>          www.imququ.com imququ.com;
    <span class="hljs-title">server_tokens</span>        <span class="hljs-built_in">off</span>;

    <span class="hljs-title">include</span>              /home/jerry/www/nginx_conf/ip.blacklist;

    <span class="hljs-comment"># https://imququ.com/post/certificate-transparency.html#toc-2</span>
    <span class="hljs-title">ssl_ct</span>               <span class="hljs-built_in">on</span>;
    <span class="hljs-title">ssl_ct_static_scts</span>   /home/jerry/www/scts;

    <span class="hljs-comment"># &#x4E2D;&#x95F4;&#x8BC1;&#x4E66; + &#x7AD9;&#x70B9;&#x8BC1;&#x4E66;</span>
    <span class="hljs-title">ssl_certificate</span>      /home/jerry/www/ssl/chained.pem;

    <span class="hljs-comment"># &#x521B;&#x5EFA; CSR &#x6587;&#x4EF6;&#x65F6;&#x7528;&#x7684;&#x5BC6;&#x94A5;</span>
    <span class="hljs-title">ssl_certificate_key</span>  /home/jerry/www/ssl/domain.key;

    <span class="hljs-comment"># openssl dhparam -out dhparams.pem 2048</span>
    <span class="hljs-comment"># https://weakdh.org/sysadmin.html</span>
    <span class="hljs-title">ssl_dhparam</span>          /home/jerry/www/ssl/dhparams.pem;

    <span class="hljs-comment"># https://github.com/cloudflare/sslconfig/blob/master/conf</span>
    <span class="hljs-title">ssl_ciphers</span>                EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    <span class="hljs-title">ssl_prefer_server_ciphers</span>  <span class="hljs-built_in">on</span>;

    <span class="hljs-title">ssl_protocols</span>              TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>;

    <span class="hljs-title">ssl_session_cache</span>          shared:SSL:<span class="hljs-number">50m</span>;
    <span class="hljs-title">ssl_session_timeout</span>        <span class="hljs-number">1d</span>;

    <span class="hljs-title">ssl_session_tickets</span>        <span class="hljs-built_in">on</span>;

    <span class="hljs-comment"># openssl rand 48 &gt; session_ticket.key</span>
    <span class="hljs-comment"># &#x5355;&#x673A;&#x90E8;&#x7F72;&#x53EF;&#x4EE5;&#x4E0D;&#x6307;&#x5B9A; ssl_session_ticket_key</span>
    <span class="hljs-title">ssl_session_ticket_key</span>     /home/jerry/www/ssl/session_ticket.key;

    <span class="hljs-title">ssl_stapling</span>               <span class="hljs-built_in">on</span>;
    <span class="hljs-title">ssl_stapling_verify</span>        <span class="hljs-built_in">on</span>;

    <span class="hljs-comment"># &#x6839;&#x8BC1;&#x4E66; + &#x4E2D;&#x95F4;&#x8BC1;&#x4E66;</span>
    <span class="hljs-comment"># https://imququ.com/post/why-can-not-turn-on-ocsp-stapling.html</span>
    <span class="hljs-title">ssl_trusted_certificate</span>    /home/jerry/www/ssl/full_chained.pem;

    <span class="hljs-title">resolver</span>                   <span class="hljs-number">114.114.114.114</span> valid=<span class="hljs-number">300s</span>;
    <span class="hljs-title">resolver_timeout</span>           <span class="hljs-number">10s</span>;

    <span class="hljs-title">access_log</span>                 /home/jerry/www/nginx_log/imququ_com.log;

    <span class="hljs-title">if</span> (<span class="hljs-variable">$request_method</span> !<span class="hljs-regexp">~ ^(GET|HEAD|POST|OPTIONS)$</span> ) {
        <span class="hljs-title">return</span>           <span class="hljs-number">444</span>;
    }

    <span class="hljs-title">if</span> (<span class="hljs-variable">$host</span> != <span class="hljs-string">&apos;imququ.com&apos;</span> ) {
        <span class="hljs-title">rewrite</span>         <span class="hljs-regexp"> ^/(.*)$</span>  <span class="hljs-url">https://imququ.com/<span class="hljs-variable">$1</span></span> <span class="hljs-built_in">permanent</span>;
    }

    <span class="hljs-title">location</span> <span class="hljs-regexp">~* (robots\.txt|favicon\.ico|crossdomain\.xml|google4c90d18e696bdcf8\.html|BingSiteAuth\.xml)$</span> {
        <span class="hljs-title">root</span>             /home/jerry/www/imququ.com/www/static;
        <span class="hljs-title">expires</span>          <span class="hljs-number">1d</span>;
    }

    <span class="hljs-title">location</span><span class="hljs-regexp"> ^~</span> /static/uploads/ {
        <span class="hljs-title">root</span>             /home/jerry/www/imququ.com/www;
        <span class="hljs-title">add_header</span>       Access-Control-Allow-Origin *;

        <span class="hljs-title">set</span>              <span class="hljs-variable">$expires_time</span> max;

        <span class="hljs-title">valid_referers</span>   <span class="hljs-built_in">blocked</span> <span class="hljs-built_in">none</span> server_names <span class="hljs-regexp">*.qgy</span>18.com <span class="hljs-regexp">*.inoreader.com</span> feedly.com <span class="hljs-regexp">*.feedly.com</span> www.udpwork.com theoldreader.com digg.com <span class="hljs-regexp">*.feiworks.com</span> <span class="hljs-regexp">*.newszeit.com</span> r.mail.qq.com yuedu.<span class="hljs-number">163</span>.com <span class="hljs-regexp">*.w</span>3ctech.com;
        <span class="hljs-title">if</span> (<span class="hljs-variable">$invalid_referer</span>) {
            <span class="hljs-title">set</span>          <span class="hljs-variable">$expires_time</span> -<span class="hljs-number">1</span>;
            <span class="hljs-title">return</span>       <span class="hljs-number">403</span>;
        }

        <span class="hljs-title">expires</span>          <span class="hljs-variable">$expires_time</span>;
    }

    <span class="hljs-title">location</span><span class="hljs-regexp"> ^~</span> /static/ {
        <span class="hljs-title">root</span>             /home/jerry/www/imququ.com/www;
        <span class="hljs-title">add_header</span>       Access-Control-Allow-Origin *;      
        <span class="hljs-title">expires</span>          max;
    }

    <span class="hljs-title">location</span><span class="hljs-regexp"> ^~</span> /admin/ {
        <span class="hljs-title">proxy_http_version</span>       <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;

        <span class="hljs-title">add_header</span>               Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains; preload&quot;</span>;
        <span class="hljs-title">add_header</span>               X-Frame-Options deny;
        <span class="hljs-title">add_header</span>               X-Content-Type-Options nosniff;

        <span class="hljs-title">proxy_set_header</span>         X-Via            QingDao.Aliyun;
        <span class="hljs-title">proxy_set_header</span>         Connection       <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-title">proxy_set_header</span>         Host             imququ.com;
        <span class="hljs-title">proxy_set_header</span>         X-Real_IP        <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-title">proxy_set_header</span>         X-Forwarded-For  <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;

        <span class="hljs-title">proxy_pass</span>               <span class="hljs-url">http://127.0.0.1:9095</span>;
    }

    <span class="hljs-title">location</span> / {
        <span class="hljs-title">proxy_http_version</span>       <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;

        <span class="hljs-title">add_header</span>               Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains; preload&quot;</span>;
        <span class="hljs-title">add_header</span>               X-Frame-Options deny;
        <span class="hljs-title">add_header</span>               X-Content-Type-Options nosniff;
        <span class="hljs-title">add_header</span>               Content-Security-Policy <span class="hljs-string">&quot;default-src &apos;none&apos;; script-src &apos;unsafe-inline&apos; &apos;unsafe-eval&apos; blob: https:; img-src data: https: http://ip.qgy18.com; style-src &apos;unsafe-inline&apos; https:; child-src https:; connect-src &apos;self&apos; https://translate.googleapis.com; frame-src https://disqus.com https://www.slideshare.net&quot;</span>;
        <span class="hljs-title">add_header</span>               Public-Key-Pins <span class="hljs-string">&apos;pin-sha256=&quot;YLh1dUR9y6Kja30RrAn7JKnbQG/uEtLMkBgFF2Fuihg=&quot;; pin-sha256=&quot;aef6IF2UF6jNEwA2pNmP7kpgT6NFSdt7Tqf5HzaIGWI=&quot;; max-age=2592000; includeSubDomains&apos;</span>;
        <span class="hljs-title">add_header</span>               Cache-Control <span class="hljs-built_in">no</span>-cache;

        <span class="hljs-title">proxy_ignore_headers</span>     Set-Cookie;

        <span class="hljs-title">proxy_hide_header</span>        Vary;
        <span class="hljs-title">proxy_hide_header</span>        X-Powered-By;

        <span class="hljs-title">proxy_set_header</span>         X-Via            QingDao.Aliyun;
        <span class="hljs-title">proxy_set_header</span>         Connection       <span class="hljs-string">&quot;&quot;</span>;
        <span class="hljs-title">proxy_set_header</span>         Host             imququ.com;
        <span class="hljs-title">proxy_set_header</span>         X-Real_IP        <span class="hljs-variable">$remote_addr</span>;
        <span class="hljs-title">proxy_set_header</span>         X-Forwarded-For  <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;

        <span class="hljs-title">proxy_pass</span>               <span class="hljs-url">http://127.0.0.1:9095</span>;
    }
}

<span class="hljs-title">server</span> {
    <span class="hljs-title">server_name</span>       www.imququ.com imququ.com;
    <span class="hljs-title">server_tokens</span>     <span class="hljs-built_in">off</span>;

    <span class="hljs-title">access_log</span>        /dev/null;

    <span class="hljs-title">if</span> (<span class="hljs-variable">$request_method</span> !<span class="hljs-regexp">~ ^(GET|HEAD|POST)$</span> ) {
        <span class="hljs-title">return</span>        <span class="hljs-number">444</span>;
    }

    <span class="hljs-title">location</span><span class="hljs-regexp"> ^~</span> /.well-known/acme-challenge/ {
        <span class="hljs-title">alias</span>         /home/jerry/www/challenges/;
        <span class="hljs-title">try_files</span>     <span class="hljs-variable">$uri</span> =<span class="hljs-number">404</span>;
    }

    <span class="hljs-title">location</span> / {
        <span class="hljs-title">rewrite</span>      <span class="hljs-regexp"> ^/(.*)$</span> <span class="hljs-url">https://imququ.com/<span class="hljs-variable">$1</span></span> <span class="hljs-built_in">permanent</span>;
    }
}
</code></pre>
<p>&#x4EE5;&#x4E0A;&#x914D;&#x7F6E;&#x4E2D;&#x7684;&#x4E00;&#x4E9B;&#x5173;&#x952E;&#x70B9;&#x5206;&#x6563;&#x5728;&#x6211;&#x4E4B;&#x524D;&#x7684;&#x8FD9;&#x4E9B;&#x6587;&#x7AE0;&#x4E2D;&#xFF1A;</p>
<ul>
<li><a href="https://imququ.com/post/my-nginx-conf-for-wpo.html">&#x672C;&#x535A;&#x5BA2; Nginx &#x914D;&#x7F6E;&#x4E4B;&#x6027;&#x80FD;&#x7BC7;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/my-nginx-conf-for-security.html">&#x672C;&#x535A;&#x5BA2; Nginx &#x914D;&#x7F6E;&#x4E4B;&#x5B89;&#x5168;&#x7BC7;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/optimize-tls-handshake.html">TLS &#x63E1;&#x624B;&#x4F18;&#x5316;&#x8BE6;&#x89E3;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/sth-about-switch-to-https.html">&#x5173;&#x4E8E;&#x542F;&#x7528; HTTPS &#x7684;&#x4E00;&#x4E9B;&#x7ECF;&#x9A8C;&#x5206;&#x4EAB;&#xFF08;&#x4E00;&#xFF09;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/sth-about-switch-to-https-2.html">&#x5173;&#x4E8E;&#x542F;&#x7528; HTTPS &#x7684;&#x4E00;&#x4E9B;&#x7ECF;&#x9A8C;&#x5206;&#x4EAB;&#xFF08;&#x4E8C;&#xFF09;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/certificate-transparency.html">Certificate Transparency &#x90A3;&#x4E9B;&#x4E8B;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/http-public-key-pinning.html">HTTP Public Key Pinning &#x4ECB;&#x7ECD;</a>&#xFF1B;</li>
<li><a href="https://imququ.com/post/why-can-not-turn-on-ocsp-stapling.html">&#x4ECE;&#x65E0;&#x6CD5;&#x5F00;&#x542F; OCSP Stapling &#x8BF4;&#x8D77;</a>&#xFF1B;</li>
</ul>
<p>&#x4E00;&#x5207;&#x59A5;&#x5F53;&#x540E;&#xFF0C;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x4E24;&#x4E2A;&#x5728;&#x7EBF;&#x670D;&#x52A1;&#x6765;&#x68C0;&#x6D4B;&#x7AD9;&#x70B9; HTTPS &#x914D;&#x7F6E;&#xFF1A;</p>
<p><strong>1&#xFF09;Qualys SSL Labs&apos;s SSL Server Test</strong></p>
<p>&#x6D4B;&#x8BD5;&#x5730;&#x5740;&#xFF1A;<a href="https://www.ssllabs.com/ssltest/index.html">https://www.ssllabs.com/ssltest/index.html</a>&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x672C;&#x535A;&#x5BA2;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x622A;&#x56FE;&#xFF1A;</p>
<p><img alt="ssllabs test of imququ.com" src="https://st.imququ.com/static/uploads/2016/03/ssllabs_test_of_imququ_com.png" width="798" itemprop="image" height="425"><a href="https://ssllabs.com/ssltest/analyze.html?d=imququ.com">&#x67E5;&#x770B;&#x5B8C;&#x6574;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C; &#xBB;</a></p>
<p><strong>2&#xFF09;HTTP Security Report</strong></p>
<p>&#x6D4B;&#x8BD5;&#x5730;&#x5740;&#xFF1A;<a href="https://httpsecurityreport.com/">https://httpsecurityreport.com/</a>&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x672C;&#x535A;&#x5BA2;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C;&#x622A;&#x56FE;&#xFF1A;</p>
<p><img alt="http security report of imququ.com" src="https://st.imququ.com/static/uploads/2016/03/http_security_report_of_imququ_com.png" width="776" itemprop="image" height="520"><a href="https://httpsecurityreport.com/?report=imququ.com">&#x67E5;&#x770B;&#x5B8C;&#x6574;&#x6D4B;&#x8BD5;&#x7ED3;&#x679C; &#xBB;</a></p>
<p>&#x672C;&#x6587;&#x94FE;&#x63A5;&#xFF1A;<a href="https://imququ.com/post/my-nginx-conf.html">https://imququ.com/post/my-nginx-conf.html</a>&#xFF0C;<a href="https://imququ.com/post/my-nginx-conf.html#comments" target="_blank">&#x53C2;&#x4E0E;&#x8BA8;&#x8BBA;</a></p><p>&#x2665; &#x672C;&#x7AD9;&#x6240;&#x6709;&#x6587;&#x7AE0;&#x5747;&#x4E3A;&#x672C;&#x4EBA;&#x539F;&#x521B;&#xFF0C;&#x5982;&#x679C;&#x4F60;&#x8BA4;&#x4E3A;&#x6211;&#x7684;&#x6587;&#x7AE0;&#x5BF9;&#x4F60;&#x6709;&#x5E2E;&#x52A9;&#xFF0C;&#x6B22;&#x8FCE;&#x8D5E;&#x52A9;&#x672C;&#x7AD9;&#x3002;<a target="_blank" href="https://imququ.com/post/about.html#toc-2">&#x8BE6;&#x60C5;&#x8BF7;&#x70B9;&#x8FD9;&#x91CC; &#xBB;</a></p></div>
</div>

</body>
</html>